variables:
  azureSubscriptionEndpoint: devops
  azureContainerRegistry: '{"loginServer":"victoryw.azurecr.io", "id" : "/subscriptions/fa5339f8-494f-4c65-8d85-6bfc495b151a/resourceGroups/container/providers/Microsoft.ContainerRegistry/registries/victoryw"}'
  dockerComposeFile: docker-compose-build.yml

trigger:
- master
stages:
  - stage: 'test_package_build_service'
    jobs:
      - job: 'test_package_build_service'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
        - task: Maven@3
          displayName: Build jar
          inputs:
            mavenPomFile: 'pom.xml'
            mavenOptions: '-Xmx3072m'
            javaHomeOption: 'JDKVersion'
            jdkVersionOption: '1.8'
            jdkArchitectureOption: 'x64'
            publishJUnitResults: true
            testResultsFiles: '**/surefire-reports/TEST-*.xml'
            goals: 'package'
        - task: DockerCompose@0
          displayName: Build services
          inputs:
            action: Build services
            azureSubscriptionEndpoint: $(azureSubscriptionEndpoint)
            azureContainerRegistry: $(azureContainerRegistry)
            dockerComposeFile: $(dockerComposeFile)
            projectName: $(Build.Repository.Name)
            qualifyImageNames: true
            additionalImageTags: $(Build.BuildId)
        - task: DockerCompose@0
          displayName: Push services
          inputs:
            action: Push services
            containerregistrytype: 'Azure Container Registry'
            azureSubscriptionEndpoint: $(azureSubscriptionEndpoint)
            azureContainerRegistry: $(azureContainerRegistry)
            dockerComposeFile: $(dockerComposeFile)
            additionalImageTags: $(Build.BuildId)
